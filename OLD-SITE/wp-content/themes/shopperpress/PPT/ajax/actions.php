<?php

/***************** DO NOT EDIT THIS FILE *************************
******************************************************************

INFORMATION:
------------

This is a core theme file, you should not need to edit 
this file directly. Code changes maybe lost during updates.

EDITED BY: MARK FAIL
------------------------------------------------------------------

******************************************************************/

$path=dirname(realpath($_SERVER['SCRIPT_FILENAME']));
$path_parts = pathinfo($path);
$p = str_replace("wp-content","",$path_parts['dirname']);	
$p = str_replace("themes","",$p);
$p = str_replace("PPT","",$p);

$p = str_replace("directorypress","",$p);
$p = str_replace("auctionpress","",$p);
$p = str_replace("couponpresspress","",$p);
$p = str_replace("shopperpress","",$p);
$p = str_replace("realtorpress","",$p);
$p = str_replace("shopperpress","",$p);

$p = str_replace("template_","",$p);
$p = str_replace("\\\\","",$p);
$p = str_replace("////","",$p);
 
require( $p.'/wp-config.php' );

global  $userdata; get_currentuserinfo();

// INCLUDE LANGUAGE
$GLOBALS['premiumpress']['language'] = get_option("language");
$PPT->Language();

 
switch($_GET['action']){
 

case "changeorderstatus": {

$RUN_QUERY = "UPDATE ".$wpdb->prefix."orderdata set order_status='".$_GET['change']."' WHERE order_id='".$_GET['id']."' LIMIT 1";
mysql_query($RUN_QUERY, $wpdb->dbh) or die(mysql_error().' on line: '.__LINE__);		

} break;

case "addGroupon": { 

 // 0. SAVE SEARCH OPTIONS SO WE DONT HAVE TO LOAD THEM AGAIN
	$getSaved = get_option('grouponapi');
	
	$ff = explode("*",$_GET['id']);
		
	// 1. BUILD THE FEED
	$url  ='http://api.groupon.com/v2/deals/'.$ff[0].'.json?client_id='.$getSaved['apiid'];
 
	// 2. GET DATA
  	$header[] = "Accept: application/json";
	$header[] = "Accept-Encoding: gzip";
	$ch = curl_init();
	  curl_setopt( $ch, CURLOPT_HTTPHEADER, $header );
	  curl_setopt($ch,CURLOPT_ENCODING , "gzip");
	  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');
	  curl_setopt( $ch, CURLOPT_URL, $url );
	  curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
	  $response = json_decode(curl_exec($ch));
	  print_r($response);
	  if(isset($response->deal)){
	  
	  	// ADD LISTING
		$my_post = array();
		$my_post['post_title'] 		= str_replace("!!aaqq","",$response->deal->title);
		$my_post['post_content'] 	= str_replace("!!aaqq","",$response->deal->pitchHtml);
		$my_post['post_excerpt'] 	= $excerpt;
		$my_post['post_author'] 	= 1;
		$my_post['post_status'] 	= "publish";
		$my_post['post_category'] 	= explode(",",$_GET['catid']);
		$POSTID = wp_insert_post( $my_post );
		
	  	// DESCRIPTIONS
		add_post_meta($POSTID, "type", "groupon");
		add_post_meta($POSTID, "image", str_replace("!!aaqq","",$response->deal->largeImageUrl));	
		
		foreach($response->deal->options as $dd){
		
			if($dd->id == $ff[1]){
			
			add_post_meta($POSTID, "tagline", str_replace("!!aaqq","",$dd->title));
			add_post_meta($POSTID, "old_price", str_replace("!!aaqq","",$dd->price->amount));
			add_post_meta($POSTID, "price", str_replace("!!aaqq","",$dd->discount->amount));
			add_post_meta($POSTID, "discount", str_replace("!!aaqq","",$dd->discountPercent));
		 	add_post_meta($POSTID, "sold", str_replace("!!aaqq","",$dd->soldQuantity));
		 	add_post_meta($POSTID, "link", str_replace("!!aaqq","",$dd->buyUrl));
			// expires
			add_post_meta($POSTID, "pexpires", str_replace("!!aaqq","",$dd->expiresAt));
			 
		 
			}		
		}  
	  
	  }
	  
	  

} break;


case "addExpedia": {

if(!is_numeric($_GET['id'])){ return "invalid ID"; }

//1. GET API DETAILS
$getSaved = get_option('expediaapi');

//2. BUILT NEW FEED STRING
$url  ='http://api.ean.com/ean-services/rs/hotel/v3/info?';
$url .= '&apiKey='.$getSaved['apiid'];
$url .= '&cid=55505';
$url .= '&locale=en_US&countryCode=GB';
$url .= '&hotelId='.$_GET['id'];

// 4. CONNECT AND GET JOB DATA
$header[] = "Accept: application/json";
$header[] = "Accept-Encoding: gzip";
$ch = curl_init();
  curl_setopt( $ch, CURLOPT_HTTPHEADER, $header );
  curl_setopt($ch,CURLOPT_ENCODING , "gzip");
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');
  curl_setopt( $ch, CURLOPT_URL, $url );
  curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
  $response = json_decode(curl_exec($ch));
 
$description = html_entity_decode($response->HotelInformationResponse->HotelDetails->propertyDescription); 
 
$ex1 = str_replace("Location.","",strip_tags(html_entity_decode($response->HotelInformationResponse->HotelDetails->propertyDescription)));
$ex2 = explode("Property Features",$ex1);

if(!isset($ex2[1])){
$ex2 = explode("Hotel Features",$ex1);
}



$excerpt = $ex2[0];
// ADD LISTING
$my_post = array();
$my_post['post_title'] 		= str_replace("!!aaqq","",$response->HotelInformationResponse->HotelSummary->name);
$my_post['post_content'] 	= $description;
$my_post['post_excerpt'] 	= $excerpt;
$my_post['post_author'] 	= 1;
$my_post['post_status'] 	= "publish";
$my_post['post_category'] 	= explode(",",$_GET['catid']);
$POSTID = wp_insert_post( $my_post );	

// DESCRIPTIONS
add_post_meta($POSTID, "info_area", html_entity_decode($response->HotelInformationResponse->HotelDetails->areaInformation));	
add_post_meta($POSTID, "info_policy", html_entity_decode($response->HotelInformationResponse->HotelDetails->hotelPolicy));	
add_post_meta($POSTID, "info_directions", html_entity_decode($response->HotelInformationResponse->HotelDetails->drivingDirections));	
add_post_meta($POSTID, "info_checkin", html_entity_decode($response->HotelInformationResponse->HotelDetails->checkInInstructions));	
add_post_meta($POSTID, "info_room", html_entity_decode($response->HotelInformationResponse->HotelDetails->roomInformation));	
// EXTRA FIELDS
add_post_meta($POSTID, "expedia_hotelID", $_GET['id']);	
foreach($response->HotelInformationResponse->HotelSummary as $key=>$val){
add_post_meta($POSTID, $key, $val);	
}
//PropertyAmenities
$ammStr = ""; $i=0;       
foreach($response->HotelInformationResponse->PropertyAmenities->PropertyAmenity as $amm){
$ammStr = $amm->amenity.",";
}
add_post_meta($POSTID, "amenities", $ammStr);	

// IMAGES
$imgStr = ""; $i=0;   
if(is_array($response->HotelInformationResponse->HotelImages->HotelImage)){    
	foreach($response->HotelInformationResponse->HotelImages->HotelImage as $img){
		if($i == 0){
		add_post_meta($POSTID, "image", $img->url);	
		}else{
		$imgStr = $img->url.",";
		}
		$i++;
	}
	add_post_meta($POSTID, "images", $imgStr);
}
// PRICE					
add_post_meta($POSTID, "price", $response->HotelInformationResponse->HotelSummary->lowRate);
// PACKAGE
add_post_meta($POSTID, "packageID", "4");
// LOCATIONS
wp_set_post_terms( $POSTID, explode(",",$_GET['locations']), 'location' );

echo "Added Successfully"; 
  /*
  
 [HotelInformationResponse] => stdClass Object
        (
            [@hotelId] => 406866
            [customerSessionId] => 0ABAA83D-B608-6891-3A72-5D2FE1D91D8B
            [HotelSummary] => stdClass Object
                (
                    [@order] => 0
                    [hotelId] => 406866
                    [name] => Garden Inn Dongmen Branch
                    [address1] => No.2066, DongMenZhong Road
                    [city] => Shenzhen
                    [postalCode] => 518000
                    [countryCode] => CN
                    [propertyCategory] => 1
                    [hotelRating] => 3
                    [tripAdvisorRating] => 3.5
                    [locationDescription] => Near Shenzhen People's Park
                    [highRate] => 29.0182
                    [lowRate] => 20.6871
                    [latitude] => 22.55057
                    [longitude] => 114.1169
                )

            [HotelDetails] => stdClass Object
                (
                    [numberOfRooms] => 118
                    [numberOfFloors] => 9
                    [checkInTime] => 12:00 PM
                    [checkOutTime] => 12:00 PM
                    [propertyInformation] => Check-in time starts at noon  Check-out time is noon  Pets not allowed   
                    [areaInformation] => Distances are calculated in a straight line from the property's location to the point of interest or attraction, and may not reflect actual travel distance. <br /><br /> Distances are displayed to the nearest 0.1 mile and kilometre. <p>Shenzhen People's Park - 0.8 km / 0.5 mi <br />International Foreign Trade Center - 0.8 km / 0.5 mi <br />Shun Hing Square - 1.3 km / 0.8 mi <br />Shenzhen Grand Theater - 1.7 km / 1.1 mi <br />Lizhi Park - 2.1 km / 1.3 mi <br />Shenzhen Museum - 2.2 km / 1.4 mi <br />Luohu Border Crossing - 2.3 km / 1.4 mi <br />Huanggang Port - 5.4 km / 3.4 mi <br />Huanggang Border Crossing - 5.9 km / 3.7 mi <br />Shenzhen Convention and Exhibition Center - 6.7 km / 4.1 mi <br />Shenzhen Golf Club - 8.5 km / 5.3 mi <br />Minsk World - 12.3 km / 7.6 mi <br />Splendid China - 14 km / 8.7 mi <br />Happy Valley - 14.6 km / 9.1 mi <br />Window of the World - 15.1 km / 9.4 mi <br /></p><p>The preferred airport for Garden Inn Dongmen Branch is Shenzhen (SZX-Shenzhen Intl.) - 32.6 km / 20.3 mi. </p>
                    [propertyDescription] => <p><b>Location. </b> <br />Garden Inn Dongmen Branch is located in central Shenzhen, close to Shenzhen People's Park, International Foreign Trade Center, and Shun Hing Square. Nearby points of interest also include Shenzhen Grand Theater and Lizhi Park. </p><p><b>Hotel Features. </b><br /> Garden Inn Dongmen Branch features multilingual staff, tour/ticket assistance, and coffee in the lobby.  Complimentary wireless and wired high-speed Internet access is available in public areas.  Additional property amenities include complimentary newspapers in the lobby, dry cleaning/laundry services, and an elevator (lift). </p><p><b>Guestrooms. </b> <br /> 118 air-conditioned guestrooms at Garden Inn Dongmen Branch feature laptop-compatible safes and coffee/tea makers. Balconies offer city views. Furnishings include desks and ergonomic chairs. Bathrooms feature showers, makeup/shaving mirrors, and slippers. Wired high-speed and wireless Internet access is complimentary. Guestrooms offer direct-dial phones. Cable television is provided. Also included are windows that open and blackout drapes/curtains. Guests may request irons/ironing boards, hair dryers, and extra towels/bedding. Housekeeping is available daily. </p>  
                    [hotelPolicy] => You must present a photo ID when checking in. Your credit card is charged at the time you book. Bed type and smoking preferences are not guaranteed.Your reservation is prepaid and is guaranteed for late arrival. The total charge includes all room charges and taxes, as well as fees for access and booking. Any incidental charges such as parking, phone calls, and room service will be handled directly between you and the property.
                    [roomInformation] => Name: Standard twin room Description: <strong><ul><li>Two Beds</li></ul></strong>Overlooking the city, this room opens to a balcony and measures 300 square feet (28 square meters). Complimentary wired and wireless Internet access keeps you connected, and the 29-inch television is offered for your entertainment. A coffee/tea maker is supplied. The private bathroom has a shower, as well as slippers and a makeup/shaving mirror. Handy amenities include air conditioning, a direct-dial phone, and a desk with ergonomic chair.  <p></p> Name: Standard queen room Description: <strong><ul><li>One Bed</li></ul></strong>Overlooking the city, this room opens to a balcony and measures 280 square feet (26 square meters). Complimentary wired and wireless Internet access keeps you connected, and the 29-inch television is offered for your entertainment. A coffee/tea maker is supplied. The private bathroom has a shower, as well as slippers and a makeup/shaving mirror. Handy amenities include air conditioning, a direct-dial phone, and a desk with ergonomic chair.  <p></p> Name: Economic room Description: <strong><ul><li>One Queen Bed</li></ul></strong>Overlooking the city, this room opens to a balcony and measures 230 square feet (21 square meters). Complimentary wired and wireless Internet access keeps you connected, and the 29-inch television is offered for your entertainment. A coffee/tea maker is supplied. The private bathroom has a shower, as well as slippers and a makeup/shaving mirror. Handy amenities include air conditioning, a direct-dial phone, and a desk with ergonomic chair.  <p></p> Name: Business queen room Description: <strong><ul><li>One Queen Bed</li></ul></strong>Overlooking the city, this room opens to a balcony and measures 320 square feet (30 square meters). Complimentary wired and wireless Internet access keeps you connected, and the 29-inch television is offered for your entertainment. A coffee/tea maker is supplied. The private bathroom has a shower, as well as slippers and a makeup/shaving mirror. Handy amenities include air conditioning, a direct-dial phone, and a desk with ergonomic chair.  <p></p> 
                    [drivingDirections] => 
                    [checkInInstructions] => Extra-person charges may apply and vary depending on hotel policy.   
  
  */
 

} break;

case "sendwink": {
 	
	// CHECK USER IS LOGGED IN
	if($userdata->ID && is_numeric($_GET['uid']) ){
	
		// ADD NEW MESSAGE	
		$my_post = array();
		$my_post['post_title'] 		= "wink";
		$my_post['post_content'] 	= "<center><img src='".PPT_CHILD_IMG."e1.png' alt='' /></center>";
		$my_post['post_excerpt'] 	= "";
		$my_post['post_status'] 	= "publish";
		$my_post['post_type'] 		= "ppt_message";
		$my_post['post_author'] 	= $_GET['uid'];
		$POSTID 					= wp_insert_post( $my_post );
		
		$user_info = get_userdata($_GET['uid']);
				
		// ADD SOME EXTRA CUSTOM FIELDS
		add_post_meta($POSTID, "username", $user_info->user_login );	
		add_post_meta($POSTID, "from", $userdata->ID);
		add_post_meta($POSTID, "status", "unread" );
		
		/*echo $POSTID;*/
	
	}

 

} break;

/* =============================================================================
   CHECK COUPON // V7.1
   ========================================================================== */

case "checkcoupon": {

// CHECK FOR ANY COUPON CODES
	if(isset($_GET['c']) && strlen($_GET['c']) > 1){

		$FoundCoupon = $PPT->Coupon(strip_tags($_GET['c']));
			
		if(!is_array($FoundCoupon)  ){ 
			 
			echo "<div class='red_box'><div class='red_box_content'><img src='".get_template_directory_uri()."/PPT/img/cross.png' align='absmiddle' /> ".$PPT->_e(array('button','32'))."</div></div>";
			
		}
	}
	
	if(isset($FoundCoupon) && is_array($FoundCoupon)){	
	
		if($FoundCoupon['price'] !="" ){  			
				$CountDiscount = premiumpress_price($FoundCoupon['price'],get_option('currency_code'),get_option('display_currency_position'),1); 			
		}else{
				$CountDiscount = $FoundCoupon['percentage']."%";
		}
	
		echo "<div class='green_box'><div class='green_box_content'><img src='".get_template_directory_uri()."/PPT/img/admin/ok.png' align='absmiddle' /> ".str_replace("%a",$CountDiscount,$PPT->_e(array('button','31')))."</div></div>";
		
		//echo "<input type='hidden' name='pptcouponcode' value='".strip_tags($_GET['c'])."' />";
	
	}
 

} break;

/* =============================================================================
   GET COUNTRY SHIP // v7
   ========================================================================== */

case "savecountryship": {

if(!is_numeric($_GET['val'])){ echo "<img src='".get_template_directory_uri()."/PPT/img/cross.png' align='absmiddle' /> The value must be numeric. "; die(); }

update_post_meta($_GET['postID'], "extraship_".strip_tags($_GET['c']), $_GET['val']);

echo "<br /><img src='".get_template_directory_uri()."/PPT/img/admin/ok.png' align='absmiddle' /> Saved";

}  break;

case "getcountryship": {

 $_GET['c'] = strip_tags($_GET['c']);
 if(!is_numeric($_GET['postID'])){ die(); }
 
 
echo '<div class="ppt-form-line nob"><span class="ppt-labeltext">Extra Shipping Cost ('.get_option('currency_symbol').')</span>
<input type="text" name="extraship_'.$_GET['c'].'" value="'.get_post_meta(strip_tags($_GET['postID']), 'extraship_'.$_GET['c'], true).'" 
onchange="savecountryship(\''.$_GET['c'].'\', this.value, \''.strip_tags($_GET['postID']).'\', \''.str_replace("http://","",PPT_THEME_URI).'/PPT/ajax/\', \'AJAXCOUNTRYSHIP\');" class="ppt-forminput" style="width:150px;" />
<div class="clearfix"></div></div> 
</div></div>';


} break;


/* =============================================================================
   WISHLIST // V7 // 25TH MARCH
   ========================================================================== */
   
case "WishList":{ 

	 
	// SWITCH THE ACTION
	if($_GET['act'] == "add"){
 
 		// CHECK TO SEE IF THE ITEM IS ALREADY ON OUR WISHLIST
		$RUN_QUERY = "SELECT count(".$wpdb->prefix."postmeta.meta_value) AS total FROM ".$wpdb->prefix."postmeta 
		INNER JOIN ".$wpdb->prefix."posts ON ( ".$wpdb->prefix."posts.ID = ".$wpdb->prefix."postmeta.post_id AND ".$wpdb->prefix."posts.post_type ='ppt_wishlist')		
		WHERE ".$wpdb->prefix."postmeta.meta_value='".$_GET['itemID']."' LIMIT 1"; 	 
	 	
		$result1 = mysql_query($RUN_QUERY, $wpdb->dbh) or die(mysql_error().' on line: '.__LINE__);						
		$array = mysql_fetch_assoc($result1);
	 
	 	// IF NO RESULTS FOUND ADD A NEW ENTRY // EDIT SINCE COMPARE AND WISHLIST SHARE THE SAME SYSTEM, LETS ALLOW UPTO 2 
		if($array['total'] < 3){
 
		$my_post = array();
		$my_post['post_title'] 		= $userdata->user_login." + ".$_GET['itemID'];
		$my_post['post_content'] 	= "";
		$my_post['post_excerpt'] 	= "";
		$my_post['post_status'] 	= "publish";
		$my_post['post_type'] 		= "ppt_wishlist";
		$my_post['post_author'] 	= $userdata->ID;
		$POSTID 					= wp_insert_post( $my_post );
		add_post_meta($POSTID, "itemID", $_GET['itemID']);	
		
		if($_GET['type'] == "wishlist"){ 
		add_post_meta($POSTID, "type", "wishlist");
		$linkstring = "?s=&pptfavs=yes";
		}else{ 
		add_post_meta($POSTID, "type", "compare");
		$linkstring = "?s=&pptfavs=compare";
		}
		
		
		print "<div class='green_box'><div class='green_box_content'><img src='".get_template_directory_uri()."/PPT/img/admin/ok.png' align='absmiddle' /> ".get_the_title($_GET['itemID'])." ".$PPT->_e(array('validate','15'))." <a href='".$GLOBALS['bloginfo_url']."/".$linkstring."' style='text-decoration:underline;'>".$PPT->_e(array('validate','16'))."</a> </div></div>";
		
		// ELSE WE NEED TO GIVE ERROR MSG TO USE		
		}else{
		
		if($_GET['type'] == "wishlist"){ 
	 
		$linkstring = "?s=&pptfavs=yes";
		}else{ 
	 
		$linkstring = "?s=&pptfavs=compare";
		}
		
		print "<div class='red_box'><div class='red_box_content'><img src='".get_template_directory_uri()."/PPT/img/cross.png' align='absmiddle' /> ".get_the_title($_GET['itemID'])." ".$PPT->_e(array('validate','17'))." <a href='".$GLOBALS['bloginfo_url']."/".$linkstring."' style='text-decoration:underline; color:#7c0f06;'>".$PPT->_e(array('validate','16'))."</a></div></div>";
		
		}
	
	// ACTION TO DELETE WISHLIST ENTRY
	}elseif($_GET['act'] == "delete"){
	
		wp_delete_post($_GET['itemID']);
	
		print $PPT->_e(array('validate','18'));
	
	}

} break;

case "deletewishlist": {

	// 0. CHECK THEY ARE A USER
	if(!$userdata->ID){	echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','1')).'</div></div>';die(); }	
	
	// 1. CHECK THE POST WE ARE DELETING IS OWNED BY THIS AUTHOR
	if(!is_numeric($_GET['alertid'])){ die(); }
	$SQL = "SELECT count(*) AS total FROM $wpdb->posts WHERE post_type = 'ppt_wishlist' AND post_author = '".$userdata->ID."' AND ID = (".$_GET['alertid'].")";	
	$found = (array)$wpdb->get_results($SQL);
 
	if($found[0]->total == 1){
	 wp_delete_post( $_GET['alertid'], true );
	}	

	// 2. RETURN USER MESSAGE
	echo '<div class="green_box"><div class="green_box_content"><img src="'.get_template_directory_uri().'/PPT/img/admin/ok.png" align="absmiddle" /> '.$PPT->_e(array('ajax','2')).'</div></div>';	
	

} break;

/* =============================================================================
   EMAIL ALTER SYSTEM // V7 // 25TH MARCH
   ========================================================================== */
   
case "deletealert": {

	// 0. CHECK THEY ARE A USER
	if(!$userdata->ID){	echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','1')).'</div></div>';die(); }	
	
	// 1. CHECK THE POST WE ARE DELETING IS OWNED BY THIS AUTHOR
	if(!is_numeric($_GET['alertid'])){ die(); }
	$SQL = "SELECT count(*) AS total FROM $wpdb->posts WHERE post_type = 'ppt_alert' AND post_author = '".$userdata->ID."' AND ID = (".$_GET['alertid'].")";	
	$found = (array)$wpdb->get_results($SQL);
 
	if($found[0]->total == 1){
	 wp_delete_post( $_GET['alertid'], true );
	}	

	// 2. RETURN USER MESSAGE
	echo '<div class="green_box"><div class="green_box_content"><img src="'.get_template_directory_uri().'/PPT/img/admin/ok.png" align="absmiddle" /> '.$PPT->_e(array('ajax','2')).'</div></div>';	
	

} break;

case "emailalter":{ 

	// 0. CHECK THEY ARE A USER
	if(!$userdata->ID){	echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','3')).'</div></div>';die(); }
	
	// 1. CREATE NEW ALERT 
	$my_post = array();
	$my_post['post_status'] 	= "publish";
	$my_post['post_type'] 		= "ppt_alert";
	$my_post['post_author'] 	= $userdata->ID;
	$POSTID 					= wp_insert_post( $my_post );
			
	add_post_meta($POSTID, "catID", $_GET['catid']);	

	// 2. RETURN USER MESSAGE
	echo '<div class="green_box"><div class="green_box_content"><img src="'.get_template_directory_uri().'/PPT/img/admin/ok.png" align="absmiddle" />'.$PPT->_e(array('ajax','4')).'</div></div>';
	 

} break;

/* =============================================================================
   SAVE SEARCH RESULTS // V7 // 25TH MARCH
   ========================================================================== */

	case "savesearch": {
	
		// 0. CHECK THEY ARE A USER
		if(!$userdata->ID){	echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','5')).'</div></div>';die(); }
	
		// 1. GET CURRENT LIST
		$clist = get_user_meta($userdata->ID, 'savesearch', true);
		
		// 2. ADD-ON NEW SEARCH
		$newlist = array(); $i=0;
		
		if(is_array($clist)){
			foreach($clist as $link){
			if($link !=""){			 
				$newlist[$i] = $link;
				$i++;
			} }
			$newlist[$i] = strip_tags(str_replace("  ","&",$_GET['thislink']));
		}else{
		$newlist[$i] =  strip_tags(str_replace("  ","&",$_GET['thislink']));
		}
		
		update_user_meta($userdata->ID, 'savesearch', $newlist);
		
		// 4. RETURN USER MESSAGE
		echo '<div class="green_box"><div class="green_box_content"><img src="'.get_template_directory_uri().'/PPT/img/admin/ok.png" align="absmiddle" /> '.$PPT->_e(array('ajax','6')).'</div></div>';
	
	} break; 
	
	
	case "getsavesearch": {
	
		// 0. CHECK THEY ARE A USER
		if(!$userdata->ID){	echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','5')).'</div></div>';die(); }
	
		// 1. GET CURRENT LIST
		$clist = get_user_meta($userdata->ID, 'savesearch', true);
		
		// 2. ADD-ON NEW SEARCH
		$newlist = array(); $i=0;
		
		if(is_array($clist) && !empty($clist) ){
		
		// 4. RETURN USER MESSAGE
		echo '<div class="green_box"><div class="green_box_content"> ';
	
			foreach($clist as $link){ if(strlen($link) > 5){
				echo "<p><a href='http://".str_replace(" ","+",str_replace("---","&",$link))."' class='button gray'>http://".str_replace(" ","+",str_replace("---","&",$link))."</a> - <a class='button green' href=\"javascript:PPTDeleteSaveSearch('".str_replace("http://","",PPT_THEME_URI)."/PPT/ajax/','".$link."','AJAXRESULTS');\">".$PPT->_e(array('button','3'))."</a><br /></p>";
				 
			} }
			
		echo ' </div></div>';
			 
		}else{
		// 4. RETURN USER MESSAGE
		echo '<div class="red_box"><div class="red_box_content"><img src="'.get_template_directory_uri().'/PPT/img/cross.png" align="absmiddle" /> '.$PPT->_e(array('ajax','7')).'</div></div>';
	
		}
		 
		
	} break;	
	
	case "deletesavesearch": {
	
		// 1. GET CURRENT LIST
		$clist = get_user_meta($userdata->ID, 'savesearch', true);
		
		// 2. ADD-ON NEW SEARCH
		$newlist = array(); $i=0;
		
		if(is_array($clist)){
			foreach($clist as $link){
				if($link !=  strip_tags(str_replace("  ","&",$_GET['thislink'])) ){
				$newlist[$i] = $link;
				$i++;
				}
			}			 
		}
		
		update_user_meta($userdata->ID, 'savesearch', $newlist);
		
		// 4. RETURN USER MESSAGE
		echo '<div class="yellow_box"><div class="yellow_box_content"><img src="'.get_template_directory_uri().'/PPT/img/thumb_up.png" align="absmiddle" /> '.$PPT->_e(array('ajax','8')).'</div></div>';
	
	} break;
	
	
		
	
	
	
	

case "addIndeed": {

//0. CHECK THIS JOB HASNT ALREADY BEEN ADDED
$SQL = "SELECT count($wpdb->postmeta.meta_key) AS total
	 FROM $wpdb->postmeta
	 WHERE $wpdb->postmeta.meta_key='jobkey' AND $wpdb->postmeta.meta_value = '".$_GET['jobid']."'
	 LIMIT 1";	
			 
	 $result = mysql_query($SQL);			 
	 $array = mysql_fetch_assoc($result);
	
	 if($array['total'] > 0){
	 
	 print '<div class="msg msg-error"><p>You have already imported this job before.</p></div>';
	 die();
	 
}

//1. GET API DETAILS
$getSaved = get_option('indeedapi');

//2. BUILT NEW FEED STRING
$feedURL = "http://api.indeed.com/ads/apigetjobs?publisher=".$getSaved['publisher']."&v=2&";

// 3. ADDON NEW JOBKEY VALUE
$feedURL .="jobkeys=".$_GET['jobid'];

// 4. CONNECT AND GET JOB DATA
$result = simplexml_load_file($feedURL);

//die(print_r($result));
/*
[result] => SimpleXMLElement Object
                (
                    [jobtitle] => Senior Software Engineer
                    [company] => Mitratech
                    [city] => Austin
                    [state] => TX
                    [country] => US
                    [formattedLocation] => Austin, TX
                    [source] => Mitratech
                    [date] => Tue, 13 Mar 2012 06:06:51 GMT
                    [snippet] =>  

	The Senior Software Engineer is responsible for coding, testing and implementing products forMitratech¡¯s corporate legal automation software suite.  Responsibilities include reviewing technical requirements and developing code using the Java programming language for an enterprise grade application... The ideal candidate will be highly motivated and have a passion for technology and creative...
                    [url] => http://www.indeed.com/viewjob?jk=16097ecfc0e479cc&indpubnum=670565225816093&atk=
                    [onmousedown] => indeed_clk(this, '');
                    [latitude] => 30.395605
                    [longitude] => -97.74725
                    [jobkey] => 16097ecfc0e479cc
                    [sponsored] => false
                    [expired] => false
                    [formattedLocationFull] => Austin, TX 78759
                    [formattedRelativeTime] => 1 day ago

*/
  
// 5. SAVE DATA TO DATABASE
$my_post = array();
$my_post['post_title'] 		= str_replace("!!aa","",$result->results->result->jobtitle);
$my_post['post_excerpt'] 	= strip_tags(substr($result->results->result->snippet,0,200))."...";
$my_post['post_content'] 	= str_replace("!!aa","",$result->results->result->snippet);
$my_post['post_author'] 	= 1;
$my_post['post_status'] 	= "publish";
$my_post['post_category'] 	= explode(",",$_GET['catid']);
$my_post['tags_input'] = str_replace(" ",",",str_replace("-","",$data['title']));;
$POSTID = wp_insert_post( $my_post );	
 

add_post_meta($POSTID, "indeed", "1");
add_post_meta($POSTID, "featured", "no");
add_post_meta($POSTID, "visible", "public");
add_post_meta($POSTID, "jobtype", "resume");
add_post_meta($POSTID, "type", "");

add_post_meta($POSTID, "map_location", str_replace("!!aa","",$result->results->result->formattedLocationFull));
add_post_meta($POSTID, "latitude", str_replace("!!aa","",$result->results->result->latitude));
add_post_meta($POSTID, "longitude", str_replace("!!aa","",$result->results->result->longitude));

add_post_meta($POSTID, "link", str_replace("!!aa","",$result->results->result->url));
add_post_meta($POSTID, "jobkey", $_GET['jobid']);
add_post_meta($POSTID, "status", "");
add_post_meta($POSTID, "image", "http://www.indeed.com/p/jobsearch.gif");

$locationArray = array(str_replace("!!aa","",$result->results->result->country),str_replace("!!aa","",$result->results->result->state),str_replace("!!aa","",$result->results->result->city));
 

foreach($locationArray as $value){ if(strlen($value) > 1){  // die($value."<--".$tax." -- ".$line[array_search($tax, $titles)]);
				
					if ( is_term( $value , 'location' ) ){
						$term = get_term_by('name', str_replace("_"," ",$value), 'location');
						$taxID = $term->term_id;
					}else{
						$args = array('cat_name' => str_replace("_"," ",$value) ); 
						$term = wp_insert_term(str_replace("_"," ",$value), 'location', $args);
						$taxID = $term->term_id;
					}
				 
					
					// INSERT NEW TAX
					wp_set_post_terms( $POSTID, $taxID, 'location', true );
				
				} } // end foreach

 



$fg = floor((strtotime(str_replace("!!aa","",$result->results->result->date)) - time())/60/60/24); if($fg  <= 0){ $edate=30; }else{ $edate =$fg;  }
add_post_meta($POSTID, "expires", $edate);

	  
// 6. PRINT NICE MESSAGE
echo "Job Saved Successfully";


} break;

case "refreshlocation": {

echo $_GET['pval']."<--";

$val = "United Kingdom";

} break;

case "searchlocation": {

// CURRENT $_GET['c']
// NAME  $_GET['name']
// JOINER $_GET['div']
// TOTAL LIST $_GET['totallist']
// STOP LIST $_GET['stop']

if($_GET['c'] == ""){ return; } $STRING=""; $EXTRA =""; $idx=""; $joiner = str_replace("_div","",$_GET['div']);  $data =""; $onChange = false;

// 1. GET TERM DETAILS BASED ON PASSED VALUE (STRING)
$term = get_term_by('name', $_GET['c'], 'location' ); 
 
// 2. MUST BUILD HIDDEN FIELD WITH SEARCH VALUE
$STRING .='<input type="hidden" name="'.strip_tags($_GET['name']).'" value="'.str_replace(" "," ",$term->name).'">'; 
 
// 3. GET THE NEW LIST OF VALUES FOR THE USER TO SELECT  
$args = array(
			'taxonomy'              => 'location',
			'child_of'              => $term->term_id,
			'hide_empty'            => 0,
			'hierarchical'          => 0,
			'use_desc_for_title'	=> 1,			 
			);

$categories = get_categories($args); $secondlevelids = array(); 
foreach($categories as $category) {	

	// STOP THE DISPLAY OF SUB VALUES
	if(!in_array($category->parent,$secondlevelids)){	
	
		if($_GET['c'] == "top" && $category->parent != 0){ continue; }
							 
		$data .= "<option value='".$category->name."'>".$category->name."</option>";								 
		$secondlevelids[] = $category->term_id;
	}	


}
 		
// 4. CREATE NEXT DIV (assumes list boxes are in order :S)
$nf = explode("-",$_GET['name']);
if(isset($_GET['stop'])){ $id = "cs-all-".($nf[2]); }else{ $id = "cs-all-".($nf[2]+1); }


// 5. DETERMIN THE NEXT DIV
if($joiner == "LocationJoiner"){

	if(isset($_GET['stop'])){ $nextDiv = "LocationJoiner1";  }else{ $nextDiv = "LocationJoiner2"; } //$onChange = true;
	
	// WE NEED TO KNOW IF THERE IS THE NEXT FIELD TO DISPLAY THE ONCHANGE EVENT
	$onChange = false;		 
	$d = get_option('ppt_s');		
	foreach($d['preset-default'] as $checkme){
	
		if(is_array($checkme)){ $foundjoiners[] = $checkme['joiner']; }
			
	}
	if(in_array("LocationJoiner2",$foundjoiners)){ $onChange =true; }
	
		 
}elseif($joiner == "LocationJoiner1"){

	if(isset($_GET['stop'])){ $nextDiv = "LocationJoiner2"; $onChange = true; }else{ $nextDiv = "LocationJoiner2"; }
 
	
	// WE NEED TO KNOW IF THERE IS THE NEXT FIELD TO DISPLAY THE ONCHANGE EVENT
	$onChange = false;		 
	$d = get_option('ppt_s');		
	foreach($d['preset-default'] as $checkme){
	
		if(is_array($checkme)){ $foundjoiners[] = $checkme['joiner']; }
			
	}
	if(in_array("LocationJoiner2",$foundjoiners)){ $onChange =true; }
 

}elseif($joiner == "LocationJoiner2"){
	if($data == ""){ echo $STRING; return; }
}else{
	$nextDiv = "";	 
}

// FIX FOR CITY VALUE
if( !isset($_GET['stop']) && $joiner == "LocationJoiner3"  ){ //$nf[2]+1) == 4 && 
$STRING .= '<div id="cityxxsave_innerdiv"></div>';
$nextDiv = "country_city_state_select3";
}

 
// 6. BUILT HTML FOR LIST 
$STRING .= "<div >";

if(($nf[2]+1) == 5 && is_numeric($_GET['c']) ){
$g = get_term( strip_tags($_GET['c']), 'location');
echo "<div id='LocationJoiner2_innerdiv'>".$g->name."</div>";
}else{


$STRING .= '<div  id="country_city_state_select'.$nf[2].'_innerdiv"><select class="selectBox selectBox-dropdown selectBox-menuShowing" name="'.$id.$idx.'" ';

	if($onChange){
	
	$STRING .= 'onChange="PPTSearchLocation(this.value,\''.$id.'\',\''.trim($nextDiv).'\','.$_GET['totallist'].',\''.str_replace("http://","",get_home_url()).'\');"';
	
	}
	
$STRING .= ' class="short" ><option value="">-------</option>'.$data.'</select></div>';

}
     
$STRING .= '</div>'; 
$STRING .= $EXTRA;

 
// DETERMIN WHICH TYPE OF LIST IT IS COUNTR/STATE/CITY
if($joiner == "LocationJoiner"){ // COUNTRY

}elseif($joiner == "LocationJoiner1"){ // CITY

}else{ } // STATE 


echo $STRING; 


}


case "suggest": {

if(strtolower(constant('PREMIUMPRESS_SYSTEM')) != "comparisonpress"){ return; }

global $PPT;

$querystr = "SELECT $wpdb->posts.* FROM $wpdb->posts, $wpdb->postmeta 
WHERE $wpdb->posts.ID = $wpdb->postmeta.post_id 
AND ( $wpdb->posts.ID LIKE '%".strip_tags(trim(htmlentities($_GET['q'])))."%'  OR
 $wpdb->posts.post_title LIKE '%".strip_tags(trim(htmlentities($_GET['q'])))."%' )
AND $wpdb->posts.post_status = 'publish' 
AND $wpdb->posts.post_type = 'post'
GROUP BY $wpdb->posts.ID LIMIT 5";
$results = $wpdb->get_results($querystr, OBJECT);

/* Get the data into a format that Smart Suggest will read (see documentation). */
$data = array('header' => array(), 'data' => array());
$data['header'] = array('title' => 'Matching Products',	'num' => 10,	'limit' => 5	);
 
foreach ($results as $result)
{
	$data['data'][] = array(
	'primary' => $result->post_title,																						
	'secondary' => substr($result->post_excerpt,0,80)."..",														
	'image' => premiumpress_image($result->ID,"",array('return'=>true)),																			
	'onclick' => "document.getElementById('matchID').value='".$result->ID."'",	
	'fill_text' => "name fill text"	
	);
}
$final = array($data);header('Content-type: application/json');echo json_encode($final);die();
} break;


case "PPTChangeCountry": {
 
$data = premiumpress_categorylist(0,"toponly",false,"location",$_GET['c']);
if(strlen($data) < 2){ return; }
if($_GET['level'] == 1){
	$STRING .='<p class="f_half left"><label>&nbsp;</label>';
	$STRING .='<select name="form[state]" onchange="PPTChangeCountry(this.value, 2, \'DisplayCountry2\')" class="short" tabindex="8"><option></option>'.$data.'</select>';              
	$STRING .='<div id="DisplayCountry2"></div>';			     
	$STRING .='</p>';  
}else{
	$STRING .='<p class="f_half left"><label>&nbsp;</label>';
	$STRING .='<select name="form[city]" onchange="PPTChangeCountry(this.value, 3, \'DisplayCountry3\')" class="short" tabindex="8" ><option></option>'.$data.'</select>';              
	$STRING .='<div id="DisplayCountry3"></div>';			     
	$STRING .='</p>';   
}
echo $STRING; 


} break;


case "vote": {

	$nv = get_post_meta($_GET['id'], 'no_votes', true);
	$yv = get_post_meta($_GET['id'], 'yes_votes', true);
	
	
	if($nv == ""){ add_post_meta($_GET['id'], 'no_votes', 0); $nv=0; }
	if($yv == ""){ add_post_meta($_GET['id'], 'yes_votes', 0); $yv=0; }

if($_GET['val'] == "yes"){	
	$yv=$yv+1;	
	update_post_meta($_GET['id'], 'yes_votes', $yv);

}elseif($_GET['val'] == "no"){	
	$nv=$nv+1;
	update_post_meta($_GET['id'], 'no_votes', $nv);
}

echo '<b class="result1 error " title="Votes up">+'.$yv.'</b><b class="result2 error " title="Votes down">-'.$nv.'</b> <input class="up"> <input class="down">';
 

} break;


	case "UserActionForm": {
	
		if($_GET['act'] == "login"){
		
			$creds = array();
			$creds['user_login']	 	= $_GET['data'];
			$creds['user_password'] 	= $_GET['data1'];
			if(strlen($_GET['cap']) > 0){
				$creds['captcha_code'] 		= $_GET['cap'];
				$_POST['captcha_code']		= $_GET['cap'];
				$_POST['si_code_log']		= $_GET['cap1'];
			}
			$creds['remember'] = true;
			 
			
			$user = wp_signon( $creds, false );
			if ( is_wp_error($user) ){
			
				echo $user->get_error_message();	
				print "<hr/><a href='javascript:void(0);' onclick=\"jQuery('#loginform').show();\" class='button gray'>".$PPT->_e(array('login','17'))."</a>";
			
			}else{
			
				print "Welcome back ".$user->display_name."<br/><br/>";
				
				print "<p class='CheckoutBtn'><a href='javascript:void(0);' onclick=\"jQuery('#step1box').hide();jQuery('#step2box').show();\" class='button grey'>".$PPT->_e(array('button','10'))."</a></p>";
				 
 			
			}
				
		
		}elseif($_GET['act'] == "register"){
		
		 
		
		}
 
 	
	
	} break;
 

 	case "icodes": {
 
	$dd = str_replace("http://","",str_replace("www.","",$_GET['mer']));
	$dd1 = explode("/",$dd);
	 

	// CHECK THIS PRODUCT DOESNT ALREADY EXIST		
	$result = mysql_query("SELECT $wpdb->posts.ID AS total FROM $wpdb->posts
	INNER JOIN $wpdb->postmeta ON
	($wpdb->posts.ID = $wpdb->postmeta.post_id AND $wpdb->postmeta.meta_key ='link' AND $wpdb->postmeta.meta_value='".PPTCLEAN($_GET['code'])."') 
	LIMIT 1", $wpdb->dbh) or die(mysql_error().' on line: '.__LINE__);
						
	$array = mysql_fetch_assoc($result);
					 
	if (empty($array['total'])) {
	
	// CREATE THE CUSTOM TITLE AND DESCRIPTION
	$ctitle = stripslashes(get_option("icodes_custom_title"));
	if($ctitle == ""){
		$CUSTOMTITLE = $_GET['title'];
	}else{	    
		$CUSTOMTITLE = str_replace("[title]",$_GET['title'],str_replace("[code]",$_GET['code'],str_replace("[merchant]",$_GET['merchant'],str_replace("[url]",$dd1[0],str_replace("[starts]",date('l jS \of F Y h:i:s A',strtotime($_GET['starts'])),str_replace("[ends]",date('l jS \of F Y h:i:s A',strtotime($_GET['exp'])),$ctitle))))));
		
		$CUSTOMTITLE = str_replace("[description]",$_GET['desc'],$CUSTOMTITLE);
	}
	
	$cdesc = stripslashes(get_option("icodes_custom_desc"));
	if($cdesc == ""){
		$CUSTOMDESC = $_GET['desc'];
	}else{
		$CUSTOMDESC = str_replace("[description]",$_GET['desc'],str_replace("[code]",$_GET['code'],str_replace("[merchant]",$_GET['merchant'],str_replace("[url]",$dd1[0],str_replace("[starts]",date('l jS \of F Y h:i:s A',strtotime($_GET['starts'])),str_replace("[ends]",date('l jS \of F Y h:i:s A',strtotime($_GET['exp'])),$cdesc))))));
		
		$CUSTOMDESC = str_replace("[title]",$_GET['title'],$CUSTOMDESC);
		  
	}
	
	
	
	
 	  $my_post = array();
	  $my_post['post_title'] 	= $CUSTOMTITLE;//$_GET['title']." at ".$dd1[0];
	  $my_post['post_content'] 	= $CUSTOMDESC;
	  $my_post['post_excerpt'] 	= $CUSTOMDESC;
	  $my_post['post_author'] 	= 1;
	  $my_post['post_status'] 	= get_option("icodes_import_status");
	  $my_post['post_category'] = array($_GET['catid']);
	  $my_post['tags_input'] = $dd1[0];
	  $POSTID = wp_insert_post( $my_post );	  
 
	  // EXTRA FIELDS
	  add_post_meta($POSTID, "code", $_GET['code']);
	  add_post_meta($POSTID, "starts", $_GET['starts']);
	  add_post_meta($POSTID, "pexpires", $_GET['exp']);
	  add_post_meta($POSTID, "url", $dd1[0]);	  
	  add_post_meta($POSTID, "hits", "1");
	  add_post_meta($POSTID, "link", str_replace("**","&",$_GET['url']));
	  add_post_meta($POSTID, "type", $_GET['type']);  
	  add_post_meta($POSTID, "image", $_GET['img']);
	  
		// UPDATE STORE  
		if ( is_term( $_GET['merchant'] , 'store' ) ){
			 $term = get_term_by('name', str_replace("_"," ",$_GET['merchant']), 'store');
			 $storeID = $term->term_id;
		}else{
			$args = array('cat_name' => str_replace("_"," ",$_GET['merchant']) ); 
			$term = wp_insert_term( str_replace("_"," ",$_GET['merchant']), 'store', $args);
			$storeID = $term->term_id;
		}
		
		wp_set_post_terms( $POSTID, $storeID, 'store' );

	  print '<div class="msg msg-ok"><p>Coupon Added Successfully</p></div>';

	}else{
		print '<div class="msg msg-error"><p>Coupon Already Exists</p></div>';
	}
 

} break;
 

 
case "caticon": {

	$text = get_option("cat_icons");
	if(is_array($text)){
	foreach($text as $key=>$icon){ 
 
	
	echo "<input type='hidden' name='cat_icons[".$key."][image]' value='".$icon['image']."' />";
	
	} }
	
	if(isset($text[$_GET['current']]['image'])){ $icon = $text[$_GET['current']]['image']; }else{ $icon ="";  }
	
	echo "<br /><div style='background:#fff; padding:5px; border:1px solid #ddd;'>";
	$i=1;
	while($i < 57){
	
	echo "<img src='".get_template_directory_uri()."/images/icons/".$i.".png' style='float:left; border:1px solid #ddd; padding:3px; margin-right:10px; margin-bottom:10px; cursor:pointer;' onclick=\"document.getElementById('caticon').value='".$i.".png'\">";
	$i++;
	}
	echo "<div style='clear:both;'></div></div>";
	
	echo "<small>Icons are 32px X 32px</small>";
 
	
	print '<input name="cat_icons['.$_GET['current'].'][image]" type="text" id="caticon" style="width: 350px;  font-size:14px;" class="ppt-forminput" value="'.$icon.'" /><br />';
	
	print '<input onclick="toggleLayer(\'DisplayImages\'); add_image_next(0,\''.get_option("imagestorage_path").'\',\''.get_option("imagestorage_link").'\',\'caticon\');" type="button"   value="View Images"  />';

 	print '<input  type="button" size="36" name="upload_caticon" value="Upload Image" onclick="ChangeCatIcon();"  />';
	
	echo ' <input class="premiumpress_button" type="submit" value="Save Changes" style="color:#fff;" onclick="document.getElementById(\'showThisTab\').value=4" />';
	
 


} break;

case "storeinfo": {

 
	print "Store Description <br ><small>Enter text or HTML for this store. </small>
	<textarea name=\"adminArray[store_".$_GET['current']."_desc]\"  style='width: 350px; height:200px;' class='ppt-forminput'>".get_option("store_".$_GET['current']."_desc")."</textarea><br><br>
	Store Image<br><small> <b>(only used with some templates, accepts http:// image links and selection) </small><br>";
	
	print '<input name="adminArray[store_'.$_GET['current'].'_logo]" type="text" id="catlogo" class="ppt-forminput" value="'.get_option("store_".$_GET['current']."_logo").'" /><br />';
	
	print '<input onclick="toggleLayer(\'DisplayImages\'); add_image_next(0,\''.get_option("imagestorage_path").'\',\''.get_option("imagestorage_link").'\',\'catlogo\');" type="button"   value="View Images"  />';

 	print '<input  type="button" size="36" name="upload_catlogo" value="Upload Image" onclick="ChangeCatLogo();"  />';
	
 


} break; 

case "cattext": {

	$text = get_option("cat_extra_text_".$_GET['current']);
	 
	
	print "Category Description <br ><small>Enter a description for this category. Allows HTML code.</small>
	<textarea name=\"adminArray[cat_extra_text_".$_GET['current']."]\"  style='width: 350px; height:200px;' class='ppt-forminput'>".stripslashes(get_option("cat_extra_text_".$_GET['current']))."</textarea><br><br>
	Category Image<br><small> <b>(only used with some templates, accepts http:// image links and selection) </small><br>";
	
	print '<input name="adminArray[cat_extra_image_'.$_GET['current'].']" type="text" id="catlogo" class="ppt-forminput" value="'.get_option("cat_extra_image_".$_GET['current']).'" /><br />';
	
	print '<input onclick="toggleLayer(\'DisplayImages\'); add_image_next(0,\''.get_option("imagestorage_path").'\',\''.get_option("imagestorage_link").'\',\'catlogo\');" type="button"   value="View Images"  />';

 	print '<input  type="button" size="36" name="upload_catlogo" value="Upload Image" onclick="ChangeCatLogo();"  />';
	
 echo ' <input class="premiumpress_button" type="submit" value="Save Changes" style="color:#fff;" onclick="document.getElementById(\'showThisTab\').value=4" />';


} break;

case "catprice": {

	$price = get_option("CatPrice");
	if(isset($price[$_GET['current']])){ $pp = $price[$_GET['current']]; }else{ $pp = 0; }
   if($price == ""){ $price=0; }
	print '<b>Current Price</b> <br />'.get_option("currency_code").'<input type="text" name="adminArray[CatPrice]['.$_GET['current'].']" value="'.$pp.'" >';
	
	print '<input class="premiumpress_button" type="submit" value="Update Price" style="color:white;background:red;" />';


} break;

case "changestate": {
 	
	include($p."/wp-content/themes/".GetThemeName()."/PPT/func/func_states.php");
 
	
	if(in_array($_GET['current'],$state_included)){
	
			
			if($_GET['current'] == "United States"){$states = $state_usa;}
			if($_GET['current'] == "China"){$states = $state_china;}
			if($_GET['current'] == "France"){$states = $state_france;}
			if($_GET['current'] == "Germany"){$states = $state_germany;}
			if($_GET['current'] == "United Kingdom"){$states = $state_uk;}
			if($_GET['current'] == "Spain"){$states = $state_spain;}
			if($_GET['current'] == "Scotland"){$states = $state_scotland;}
			if($_GET['current'] == "Romania"){$states = $state_romania;}
			if($_GET['current'] == "Canada"){$states = $state_canada;}
			if($_GET['current'] == "India"){$states = $state_india;}
			if($_GET['current'] == "Indonesia"){$states = $state_indonesia;}
			if($_GET['current'] == "Australia"){$states = $state_australia;}
			if($_GET['current'] == "Malaysia"){$states = $state_malaysia;}
			
			 
			 
			if(isset($_GET['admin'])){
			$string = '<select name="adminstate" class="ppt-forminput" id="state"><option value="0">-------------</option>';
			}elseif(isset($_GET['ship'])){
			$string = '<p class="f_half left"><label>'.$PPT->_e(array('myaccount','30')).'</label><select name="shipping[state]" class="short" id="state" tabindex="11" ><option value="0">-------------</option>';
			}else{
			$string = '<p class="f_half left"><label>'.$PPT->_e(array('myaccount','30')).'</label><select name="form[state]"  class="short" id="state" tabindex="11" ><option value="0">-------------</option>'; // onchange="PremiumPressChangeCity(this.value)"
			}
			
			if(isset($_GET['cstate'])){
			$string .= '<option value="'.$_GET['cstate'].'" selected=selected>'.$_GET['cstate'].'</option>';
			}			 
			
			foreach($states as $val){
			
				if(isset($_GET['val']) && $_GET['val'] == 100 || isset($_GET['admin']) ){
				
				$tv = get_option('citytax_'.$val);
				$string .= '<option value="'.$val.'">'.$val.'';
				if(strlen($tv) > 0){
					$string .= ' (Currently: '.get_option('citytax_'.$val).'%)';
				}
				$string .= '</option>';
				}else{
				$string .= '<option value="'.$val.'">'.$val.'</option>';
				}
				
			}
			
			$string .= '</select></p>';
			
			$string .= '<div id="PremiumPressCity"> </div><!-- AJAX CITY LIST -->';
			
			print $string;
	
	}else{
	 
		if(isset($_GET['ship'])){
		print  '<p class="f_half left"><label class="col1">'.$PPT->_e(array('myaccount','30')).'</label><input type="text" name="shipping[state]" class="short" size="35" maxlength="200" id="state" tabindex="11" /></p>';
		}else{
		print  '<p class="f_half left"><label class="col1">'.$PPT->_e(array('myaccount','30')).'</label><input type="text" name="form[state]" class="short" size="35" maxlength="200" id="state" tabindex="11" value="'.strip_tags($_GET['cstate']).'" /></p>';
		}
	
		 
	}
	
		
	
	} break;






case "add_image_next": {
 
	// GET IMAGE DATA FROM THE FOLDER
	$d = dir($_GET['path']);
	while (false !== ($entry = $d->read())) {
		if (preg_match("/(\.gif$)/i", strtolower($entry)) || preg_match("/(\.jpg$)/i", strtolower($entry)) || preg_match("/(\.jpeg$)/i", strtolower($entry)) || preg_match("/(\.png$)/i", strtolower($entry))){
		
		if(isset($_GET['search']) && strlen($_GET['search']) > 1 && $_GET['search'] != "undefined" ){
	 
			$pos = strpos($entry, $_GET['search']); 
			if ($pos === false) {}else{$pics[] = $entry;}
			
			}else{
				$pics[] = $entry;
			}
		}
	}
	 
	$d->close();
	$checkbox=1;
	$numPerRow = 25;
	$numPics = count($pics);
	if(!isset($_GET['p'])){ $c_page = 0; }else { $c_page = $_GET['p']*$numPerRow; } 
	$dd = ceil($numPics/$numPerRow);

	print '<div style="padding:10px;border:1px solid #ddd; background:#efefef; width:98%">';
	
	?>
	<input name="search" type="text" style="font-size:18px; width:200px; background:#ceffcf; border:2px solid #5ae15d;" id="searchBox2" value="keyword..">
	<input  type="button" style="font-size:18px; background:#a70303; color:white;padding:5px;" value="Search" onclick="document.getElementById('searchBox1').value = document.getElementById('searchBox2').value; add_image_next(0,'<?php echo $_GET['path']; ?>','<?php echo $_GET['link']; ?>','<?php echo $_GET['type']; ?>','<?php echo $_GET['div']; ?>');">
	<div style="clear:both;"></div>
    
	<?php
	
	if(strpos($_GET['link'],"https") === false){ $showhttp = "http://"; }else{ $showhttp = ""; }


	for ($i=0; $i < $numPics; $i++){ 
	if($i > $c_page-1 && $i < $c_page+$numPerRow ){
	$currThumb = $thispic + $i; if(strlen($pics[$currThumb]) > 1){ ?>

	<div style="float:left; width:140px; margin:10px; margin-left:0px; border:1px solid #dddddd; background:#fff; padding:5px;">
	<div style="height:110px; overflow:hidden;">
	<a href="<?php echo $showhttp; echo $_GET['link'].$pics[$currThumb] ?>" target="_blank" rel="image_group"><img src="<?php echo $showhttp; echo $_GET['link'].$pics[$currThumb]; ?>" style="max-width:140px;" border="0" /></a>
	</div>
	<div style="background:#efefef; border:1px solid #ddd; padding:5px; margin-top:10px;">  
	<a href="#" onclick="document.getElementById('<?php echo $_GET['type']; ?>').value='<?php echo $pics[$currThumb]; ?>'; toggleLayer('DisplayImages');"><img src="<?php echo $GLOBALS['template_url']; ?>/PPT/img/premiumpress/led-ico/accept.png" align="middle"> Select </a>
	 </div>
	<div style="height:20px; overflow:hidden;"><small><b><?php echo $pics[$currThumb] ?></b></small></div>
	</div>

	<?php $checkbox++; } } } ?>
	<div class="clearfix"></div>
	
	<div class="pagination">
	<ul>
	<li><b>Showing Page <?php echo $_GET['p']+1; ?> of <?php if($dd ==0){ echo "1"; }else{ echo $dd; }; ?></b></li>
	<?php $pc = $dd;while($pc > 0){$pnum = $pc; ?>
	<li><a href='javascript:void(0);' onclick="add_image_next(<?php echo $pnum-1; ?>,'<?php echo $_GET['path']; ?>','<?php echo $_GET['link']; ?>','<?php echo $_GET['type']; ?>','<?php echo $_GET['div']; ?>');"><?php echo $pc; ?></a></li>
	<?php $pc--; } ?>
	</ul>
	</div>

<?php } break;













case "add_video_next": {

	// GET IMAGE DATA FROM THE FOLDER
	$d = dir($_GET['path']);
 
	while (false !== ($entry = $d->read())) {
	
		//if (preg_match("/(\.gif$)/i", strtolower($entry)) || preg_match("/(\.jpg$)/i", strtolower($entry)) || preg_match("/(\.jpeg$)/i", strtolower($entry)) || preg_match("/(\.png$)/i", strtolower($entry))){
		
		if(isset($_GET['search']) && strlen($_GET['search']) > 1 && $_GET['search'] != "undefined" ){
	 
			$pos = strpos($entry, $_GET['search']); 
			if ($pos === false) {}else{$pics[] = $entry;}
			
			}else{
				$pics[] = $entry;
			}
		//}
	}
	
	$d->close();
	$checkbox=1;
	$numPerRow = 25;
	$numPics = count($pics);
	if(!isset($_GET['p'])){ $c_page = 0; }else { $c_page = $_GET['p']*$numPerRow; } 
	$dd = ceil($numPics/$numPerRow);

	print '<div style="padding:10px;border:1px solid #ddd; background:#efefef; width:98%">';
	
	?>
	<input name="search" type="text" style="font-size:18px; width:200px; background:#ceffcf; border:2px solid #5ae15d;" id="searchBox2" value="keyword..">
	<input  type="button" style="font-size:18px; background:#a70303; color:white;padding:5px;" value="Search" onclick="document.getElementById('searchBox1').value = document.getElementById('searchBox2').value; add_image_next(0,'<?php echo $_GET['path']; ?>','<?php echo $_GET['link']; ?>','<?php echo $_GET['type']; ?>','<?php echo $_GET['div']; ?>');">
	<div style="clear:both;"></div>
    
	<?php

	for ($i=0; $i < $numPics; $i++){  
	if($i > $c_page-1 && $i < $c_page+$numPerRow ){
	
	$currThumb = $thispic + $i; if(strlen($pics[$currThumb]) > 3){ ?>

	<div style="float:left; width:140px; margin:10px; margin-left:0px; border:1px solid #dddddd; background:#fff; padding:5px;">
	<div style="height:110px; overflow:hidden;">
	<a href="http://<?php echo $_GET['link'].$pics[$currThumb] ?>" target="_blank" rel="image_group"><img src="http://<?php echo $_GET['link'].$pics[$currThumb]; ?>" style="max-width:140px;" border="0" /></a>
	</div>
	<div style="background:#efefef; border:1px solid #ddd; padding:5px; margin-top:10px;">  
	<!--<a href="http://<?php echo $_GET['link'].$pics[$currThumb] ?>" target="_blank" rel="image_group"><img src="<?php echo $GLOBALS['template_url']; ?>/PPT/img/premiumpress/led-ico/find.png" align="middle"> View</a> - -->
	<a href="#" onclick="document.getElementById('<?php echo $_GET['type']; ?>').value='<?php echo $pics[$currThumb]; ?>'; toggleLayer('DisplayImages');"><img src="<?php echo $GLOBALS['template_url']; ?>/PPT/img/premiumpress/led-ico/accept.png" align="middle"> Select </a>
	 </div>
	<small><b><?php echo $pics[$currThumb] ?></b></small>
	</div>

	<?php $checkbox++; } } } ?>
	<div class="clearfix"></div>
	
	<div class="pagination">
	<ul>
	<li><b>Showing Page <?php echo $_GET['p']+1; ?> of <?php if($dd ==0){ echo "1"; }else{ echo $dd; }; ?></b></li>
	<?php $pc = $dd;while($pc > 0){$pnum = $pc; ?>
	<li><a href='javascript:void(0);' onclick="add_image_next(<?php echo $pnum-1; ?>,'<?php echo $_GET['path']; ?>','<?php echo $_GET['link']; ?>','<?php echo $_GET['type']; ?>','<?php echo $_GET['div']; ?>');"><?php echo $pc; ?></a></li>
	<?php $pc--; } ?>
	</ul>
	</div>

<?php } break;














case "icodesList":{

	switch($_GET['type']){
	
		case "Category":{	
		
			$list = get_option('icodes_categorylist');
			print '<select name="icodes_s_3">';
			foreach($list as $cat){
			print '<option value="'.$cat['id'].'">'.str_replace("_"," ",$cat['name']).'</option>';	
			}
			print '</select>';
			
		} break;
		case "Network":{ 	
		
			$list = get_option('icodes_networklist');
			print '<select name="icodes_s_3">';
			foreach($list as $cat){
			print '<option value="'.$cat['id'].'">'.str_replace("_"," ",$cat['name']).'</option>';	
			}
			print '</select>';	
		
		} break;
		case "Merchant":{ 	
		
			$list = get_option('icodes_merchantlist');			
			
			print '<select name="icodes_s_3">';
			foreach($list as $cat){
			print '<option value="'.$cat['id'].'">'.str_replace("_"," ",$cat['name_merchant']).'</option>';	
			}
			print '</select>';
			
		} break;
	
	}
 

} break;
 







	case "addAmazonProduct": { 
 
	 $SQL = "SELECT count($wpdb->postmeta.meta_key) AS total
	 FROM $wpdb->postmeta
	 WHERE $wpdb->postmeta.meta_key='amazon_guid' AND $wpdb->postmeta.meta_value = '".$_GET['asnid']."'
	 LIMIT 1";	
			 
	 $result = mysql_query($SQL);			 
	 $array = mysql_fetch_assoc($result);
	
	 if($array['total'] > 0){
	 
	 print '<div class="msg msg-error"><p>You have already imported this product before.</p></div>';
	 die();
	 
	 }
	 
 	require_once (TEMPLATEPATH ."/PPT/class/class_amazon.php");		
	$obj = new AmazonProductAPI();
	$result = $obj->getItemByAsin($_GET['asnid'],$_GET['country']);			
		 
    foreach($result->Items->Item as $val){
	
	 
 
   
	$data['title'] 		= str_replace("!!aaqq","",$val->ItemAttributes->Title);
	$data['asin'] 		= str_replace("!!aaqq","",$val->ASIN);
	$data['url'] 		= str_replace("!!aaqq","",$val->DetailPageURL);
	//$data['qty']		= str_replace("!!aaqq","",$val->ItemAttributes->NumberOfItems);
	$data['desc']		= nl2br(str_replace(".",". ",$val->EditorialReviews->EditorialReview->Content));
	$data['offerdesc']	= nl2br(str_replace(".",". ",$val->Offers->Offer));
	
	$data['image'] 		= str_replace("!!aaqq","",$val->LargeImage->URL);
	$data['thumbnail']	= str_replace("!!aaqq","",$val->MediumImage->URL);
	$data['images'] 	= "";
	$data['warranty']	= str_replace("!!aaqq","",$val->ItemAttributes->Warranty);	
	$data['price'] 		= str_replace("!!aaqq","",$val->ItemAttributes->ListPrice->Amount);
	
	$data['reviews'] = str_replace("!!aaqq","",$val->CustomerReviews->HasReviews);
	$data['reviewsLink'] = str_replace("!!aaqq","",$val->CustomerReviews->IFrameURL);
 

	if( $data['price'] == "Too low to display"){
		
	print '<div class="msg msg-error"><p>Product price is invalid as its a promotional item Amazon is running and cannot be added.</p></div>';
	die();
		
	}
	
	if($data['price'] == ""){
		$data['price'] = str_replace("!!aaqq","",$val->OfferSummary->LowestNewPrice->Amount);
	}
	
	//die(print_r($val));
	
	if(isset($val->Offers->Offer->OfferListing->Price->Amount) && strlen($val->Offers->Offer->OfferListing->Price->Amount) > 1){
	
			$data['old_price'] = $data['price'];
			$data['price'] 	=  str_replace("!!aaqq","",$val->Offers->Offer->OfferListing->Price->Amount);	
	}	
 
	// Load price options
	if($_GET['country'] == "jp"){
	
	}else{
		$data['old_price'] = substr($data['old_price'],0, -2).".".substr($data['old_price'],-2);
		if($data['old_price'] == "."){ $data['old_price']=""; }
 		$data['price'] = substr($data['price'],0, -2).".".substr($data['price'],-2);
	}	
	
	
	if($data['old_price'] ==  $data['price']){
	$data['old_price'] = "";
	}

 

	$AFFLINK = "http://www.amazon.".$_GET['country']."/o/ASIN/%asin%/%amazon_id%";
	$AFFLINK = str_replace("%asin%",$data['asin'],$AFFLINK);
	$AFFLINK = str_replace("%amazon_id%",'YOURUSERID',$AFFLINK);	
	
	// IMAGE SETS	
	if(isset($val->ImageSets->ImageSet)){	
	$i=1;
		foreach($val->ImageSets->ImageSet as $img){ if($i < 6){
			$data['images'] .= $img->LargeImage->URL.",";
		$i++; } }
	}
 
	
	// GET PRODUCT FEATURES
	if(isset($val->ItemAttributes->Feature) && !empty($val->ItemAttributes->Feature)){
	
	$excerpt="<h3>Features Include</h3><hr><ul>";
	foreach($val->ItemAttributes->Feature as $feature){
	$excerpt .="<li>".$feature."</li>";
	}
	$excerpt.="</ul>";	
	}
 
 	
	
	if(strlen($excerpt) < 10){ $excerpt = $extra_data; }		
	
		$data['desc'] 		= str_replace(":"," : ",$data['desc']);
		$excerpt 		= str_replace(":"," : ",$excerpt);
		//die($_GET['catid']."<--");
		/*
		if(strlen($data['title']) > 45){
		$ssss = explode(" ",str_replace("with","",$data['title']));
		$name = ""; $i=0;
			 while($i < count($ssss)){
				 if(strlen($name) < 45){
					$name .= $ssss[$i]." ";
					}
			  $i++;		 
			 }		 
		}else{
		$name  = $data['title'];
		}
		*/
		
	// PRICE IS THE WRONG WAY AROUND
	if($data['old_price'] !="" && $data['old_price'] < $data['price']){	 
		$s1 = $data['price'];
		$data['price'] = $data['old_price'];
		$data['old_price'] =  $s1;
	}
 
  //die($data['price']."<--".$data['old_price']);
 
	 
 	  $my_post = array();
	  $my_post['post_title'] 	= $data['title'];
	  $my_post['post_content'] 	= $data['desc'].$extra_data;
	  $my_post['post_excerpt'] 	= strip_tags(substr($data['desc'],0,230))."...";
	  $my_post['post_author'] 	= 1;
	  $my_post['post_status'] 	= "publish";
	  $my_post['post_category'] = explode(",",$_GET['catid']);
	  
	  // CLEAN UP TAGS
	  $tagsc = str_replace(" ",",",str_replace("-","",$data['title']));
	  $tg1 = explode(",",$tagsc); $tagsclean = array();
	  if(is_array($tg1)){	  
		  foreach($tg1 as $t){
			  if(strlen($t) > 3){
			  $tagsclean[] = $t;
			  }	  
		  }	 
		  $my_post['tags_input'] = $tagsclean; 
	  }
	  	  
	  
	  $POSTID = wp_insert_post( $my_post );	  
	  
	  $data['price'] 		= str_replace(",","",$data['price']);
	  $data['old_price']  	= str_replace(",","",$data['old_price']);
	 
	 
	if(strtolower(constant('PREMIUMPRESS_SYSTEM')) == "auctionpress"){ 
		
			add_post_meta($POSTID, "buy_link", $AFFLINK);
		  	add_post_meta($POSTID, "amazon_guid", $data['asin']);
			add_post_meta($POSTID, "price_current", $data['price']);
			add_post_meta($POSTID, "expires", 90);	
			add_post_meta($POSTID, "bid_count", 0);	
			add_post_meta($POSTID, "bid_status", "open");
			add_post_meta($POSTID, "shipping_price", 0);
		  	add_post_meta($POSTID, "image", $data['image']);
			add_post_meta($POSTID, "images", str_replace($data['image'].",","",$data['images']));
			add_post_meta($POSTID, "featured", "no");
		  	add_post_meta($POSTID, "amazon_reviews", $data['reviews']);
		  	add_post_meta($POSTID, "amazon_reviews_link", $data['reviewsLink']);	
			  	 			  
		}else{
		
		  // EXTRA FIELDS
		  add_post_meta($POSTID, "amazon_link", $AFFLINK);
		  add_post_meta($POSTID, "amazon_guid", $data['asin']);
		  add_post_meta($POSTID, "price", $data['price']);
		  if(isset($data['old_price']) && strlen($data['old_price']) > 1){ add_post_meta($POSTID, "old_price", $data['old_price']); }
		  add_post_meta($POSTID, "warranty", $data['warranty']);
		  
		  add_post_meta($POSTID, "image", $data['image']);
		  add_post_meta($POSTID, "images", str_replace($data['image'].",","",$data['images']));	  
		  add_post_meta($POSTID, "qty", "10");	  
		  add_post_meta($POSTID, "featured", "no");
		  add_post_meta($POSTID, "amazon_reviews", $data['reviews']);
		  add_post_meta($POSTID, "amazon_reviews_link", $data['reviewsLink']);		
		  
		 
	   } 
	  
	  if(strlen($_GET['tax']) > 1){
		  $a = explode("*",$_GET['tax']);
			  foreach($a as $newtax){
				  $b = explode("-",$newtax);
				  if($b[0] != "" && $b[1] != ""){
					 wp_set_post_terms( $POSTID, $b[1], $b[0] );
					 //die($POSTID."--".$b[1]."--".$b[0]);
				  }
			  }	  
		  }
 
 
	print '<div class="msg msg-ok"><p>Product Added Successfully</p></div>';
	
	}
			
			
	
	} break;





	case "addEbayProduct": {


	 $SQL = "SELECT count($wpdb->postmeta.meta_key) AS total
	 FROM $wpdb->postmeta
	 WHERE $wpdb->postmeta.meta_key='ebay_ID' AND $wpdb->postmeta.meta_value = '".$_GET['ID']."'
	 LIMIT 1";	
			 
	 $result = mysql_query($SQL);			 
	 $array = mysql_fetch_assoc($result);
	
	 if($array['total'] > 0){
	 
	 print '<div class="msg msg-error"><p>You have already imported this product before.</p></div>';
	 die();
	 
	 }	
	 
	$appid 		= $_GET['API'];  // Replace with your own AppID

	// API request variables
	$endpoint 	= 'http://svcs.ebay.com/services/search/FindingService/v1';  // URL to call
	$version 	= '1.0.0';  // API version supported by your application
	$globalid 	= $_GET['country'];  // Global ID of the eBay site you want to search (e.g., EBAY-DE)
	$query 		= $_GET['ID'];  // You will need to supply your own query
	$SafeQuery 	= urlencode($query);  // Make the query URL-friendly
	
	// Construct the findItemsByKeywords call 
	$apicall = "$endpoint?";
	$apicall .= "OPERATION-NAME=findItemsByKeywords";
	$apicall .= "&SERVICE-VERSION=$version";
	$apicall .= "&SECURITY-APPNAME=$appid";
	$apicall .= "&GLOBAL-ID=$globalid";
	$apicall .= "&keywords=$SafeQuery";
	$apicall .= "&paginationInput.entriesPerPage=2"; // items per page
	$apicall .= "&paginationInput.pageNumber=1&outputSelector(0)=SellerInfo&outputSelector(1)=StoreInfo"; // page nav
	$apicall .= "&sortOrder=CurrentPriceHighest";
	if(strlen($_GET['aff1']) > 1){
	$apicall .= "&affiliate.networkId=9";
	$apicall .= "&affiliate.trackingId=".$_GET['aff1'];
	$apicall .= "&affiliate.customId=".$_GET['aff2'];
	} 
	 
	//print $apicall;
	$resp = simplexml_load_file($apicall);
	//print_r($resp);
	if($resp->paginationOutput->totalEntries =='0'){
	
	
	 print '<div class="msg msg-error"><p>Item Not Added. eBay have restricted this item.</p></div>';
	 die();
	 
	
	}

	if(strlen($resp->errorMessage->error->message) > 2){
	
	print $resp->errorMessage->error->message;
	
	}else{
	// Check to see if the response was loaded, else print an error
	 if ($resp) {
	 
		 foreach($resp->searchResult->item as $item) { 
	 
		//die(print_r($item));
		$my_post = array();
		$my_post['post_title'] 		= str_replace("!!aaqq","",$item->title);
		$my_post['post_content'] 	= str_replace("!!aaqq","",$item->subtitle);
		$my_post['post_excerpt'] 	= str_replace("!!aaqq","",$item->subtitle);
		$my_post['post_author'] 	= 1;
		$my_post['post_status'] 	= "publish";		
		
		$item['cat'] 	= str_replace("!!aaqq","",$primaryCategory->$categoryName);
		
		// FIRST LETS CREATE A CATEGORY IF IT DOESNT ALREADY EXISTS
		/*if ( is_term( $item['cat'] , 'category' ) ){			  
			 $term = get_term_by('name', str_replace("_"," ",$item['cat']), 'category');
			 $ThisCatID = $term->term_id;
		 }else{
			$ThisCatID = wp_create_category1(str_replace("_"," ",$item['cat']), 0);		 
		 }*/
		 
		$my_post['post_category'] = array($_GET['catid']);
		
		// COMPARE PRODUCT SETUP FOR COMPARISONPRESS	  
		if(isset($_GET['matchid']) && $_GET['matchid'] !="" && is_numeric($_GET['matchid']) ){
			 $my_post['post_type'] 	= "ppt_compare";
		}else{
			  $my_post['post_type'] 	= "post";
		}
		// INSERT NEW POST	  
		$POSTID = wp_insert_post( $my_post );
			  
		// ADDED IN VERSION 7, TO MATCH UP LISTING WITH PARENT LISTINGS FOR SOME THEMES :)
		if(isset($_GET['matchid']) && $_GET['matchid'] !="" && is_numeric($_GET['matchid']) ){			  
		add_post_meta($POSTID, "pID", $_GET['matchid']);			  
		}			  
		
		// EXTRA FIELDS
		add_post_meta($POSTID, "ebay_itemId", str_replace("!!aaqq","",$item->itemId));
		add_post_meta($POSTID, "ebay_globalId", str_replace("!!aaqq","",$item->globalId));		
		add_post_meta($POSTID, "ebay_ID", str_replace("!!aaqq","",$_GET['ID']));
		add_post_meta($POSTID, "buy_link", str_replace("!!aaqq","",$item->viewItemURL));
		add_post_meta($POSTID, "payment_method", str_replace("!!aaqq","",$item->paymentMethod));
		
		
		if(strtolower(constant('PREMIUMPRESS_SYSTEM')) == "auctionpress"){ 

			//if($item->listingInfo->buyItNowAvailable){
			//add_post_meta($POSTID, "price_bin", str_replace("!!aaqq","",$item->sellingStatus->currentPrice));
			//} 
		
			add_post_meta($POSTID, "price_current", str_replace("!!aaqq","",$item->sellingStatus->currentPrice));
			add_post_meta($POSTID, "bid_count", str_replace("!!aaqq","",$item->sellingStatus->bidCount));	
			add_post_meta($POSTID, "bid_status", "open");
			add_post_meta($POSTID, "shipping_price", str_replace("!!aaqq","",$item->shippingInfo->shippingServiceCost));
			  
		}else{			  
			  add_post_meta($POSTID, "price", str_replace("!!aaqq","",$item->sellingStatus->currentPrice));
			  add_post_meta($POSTID, "qty", 1);
		}
 
		
		// DATE EXPIRED	
		$fg = floor((strtotime($item->listingInfo->endTime) - time())/60/60/24); if($fg  <= 0){ $edate=1; }else{ $edate =$fg;  }
			
		add_post_meta($POSTID, "expires", $edate);			
		add_post_meta($POSTID, "map_location", str_replace("!!aaqq","",$item->location));
		add_post_meta($POSTID, "featured", "no");
		add_post_meta($POSTID, "image", str_replace("!!aaqq","",$item->galleryURL)); 
			  
			 if(strlen($_GET['tax']) > 1){
			  $a = explode("*",$_GET['tax']);
				  foreach($a as $newtax){
					  $b = explode("-",$newtax);
					  if($b[0] != "" && $b[1] != ""){
						 wp_set_post_terms( $POSTID, $b[1], $b[0] );
					  }
				  }	  
			  }
			  
			  print '<div class="msg msg-ok"><p>Product Added Successfully</p></div>';
		 
		 }
	 
	 }else{
	 
	 print '<div class="msg msg-error"><p>Product Import Failed. '.$resp->errorMessage->error->message.'</p></div>';
	 }
	}

	
	
	
	} break;


case "addMovie" : {
 

	switch($_GET['network']){
	
	case "metacafe": { 
	 
	 
	include($p."/wp-content/themes/".GetThemeName()."/PPT/class/class_video.php");
	$embedCode = new VideoProvider();
	
	$data =  $embedCode->getEmbedCode("http://www.metacafe.com/watch/".$_GET['ID']."/00/"); 
 
	if(is_array($data)){
	$my_post = array();
	$my_post['post_title'] 		= $data['title'];
	$my_post['post_content'] 	= strip_tags($data['desc']);
	$my_post['post_excerpt'] 	= substr(strip_tags($data['desc']),0,200);
	$my_post['post_author'] 	= 1;
	$my_post['post_status'] 	= "publish";
	$my_post['post_category'] 	= explode(",",$_GET['catid']);
	$my_post['tags_input'] 		= str_replace(" ",",",str_replace("-","",$data['title']));
	$POSTID = wp_insert_post( $my_post );	
	 	
	// EXTRA FIELDS
	add_post_meta($POSTID, "MoveID", $_GET['ID']);	
	add_post_meta($POSTID, "image", "http://www.metacafe.com/thumb/".$_GET['ID'].".jpg");
	//add_post_meta($POSTID, "author", $sxml->channel->item->author);
	add_post_meta($POSTID, "code", $data['embed']);
	add_post_meta($POSTID, "embed", "1");
	
	print '<div class="msg msg-ok"><p>MetaCafe Video Added Successfully</p></div>';
	
	}else{
	print '<div class="msg msg-error"><p>MetaCafe Video Failed</p></div>';
	}
	
	} break;

	case "youtube": {
		
			include($p."/wp-content/themes/".GetThemeName()."/PPT/class/class_video.php");
			 
			
			$youtube 	= new YouTube( $_GET['ID'] );
			
			$meta	 	= $youtube->get_meta();
			//$author		= $youtube->get_author();
			$comments	= $youtube->get_comments();
			
			 
				  $my_post = array();
				  $my_post['post_title'] 	= $meta['title'];
				  $my_post['post_content'] 	= nl2br( $meta['description'] );
				  $my_post['post_excerpt'] 	= substr($meta['description'],0,200);
				  $my_post['post_author'] 	= 1;
				  $my_post['post_status'] 	= "publish";
				  $my_post['post_category'] = explode(",",$_GET['catid']);
				  $my_post['tags_input'] = str_replace(" ",",",str_replace("-","",$data['title']));;
				  $POSTID = wp_insert_post( $my_post );	  
			 
			 
					// EXTRA FIELDS
					add_post_meta($POSTID, "MoveID", str_replace("11111111111111111","",$_GET['ID']));
					add_post_meta($POSTID, "image", str_replace("11111111111111111","",$meta['thumb']));
					add_post_meta($POSTID, "duration", sprintf( "%0.2f", str_replace("11111111111111111","",$meta['duration']) / 60 ));
					add_post_meta($POSTID, "rating", str_replace("11111111111111111","",$meta['rating']));
					//add_post_meta($POSTID, "author", str_replace("11111111111111111","",$author['username']));
					//add_post_meta($POSTID, "location", str_replace("11111111111111111","",$author['location']));
					add_post_meta($POSTID, "featured", "no");
					//add_post_meta($POSTID, "embed", str_replace("11111111111111111","",$meta['embed']));
					add_post_meta($POSTID, "hits", str_replace("11111111111111111","",$meta['views']));
				
					
				  if(is_array($comments['comments'])){ foreach( $comments['comments'] as $comment ) { 
			
					$data = array(
						'comment_post_ID' => $POSTID,
						'comment_author' => $review->Reviewer->Name,
						'comment_author_email' => 'admin@admin.com',
						'comment_author_url' => 'http://',
						'comment_content' => nl2br($comment),
						//'comment_type' => ,
						'comment_parent' => 0,
						'user_ID' => 1,
						'comment_author_IP' => '127.0.0.1',
						'comment_agent' => 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.10) Gecko/2009042316 Firefox/3.0.10 (.NET CLR 3.5.30729)',
					 
						 
						'comment_approved' => 1,
					);
					
					wp_insert_comment($data);
					
				  }  }
				  
				  print '<div class="msg msg-ok"><p>YouTube Video Added Successfully</p></div>';

		  
	} break;
	   
	}
		   

}



















case "changeProperty": {

if(is_numeric($_GET['d'])){

	$GLOBALS['premiumpress']['language'] = get_option("language");
	$PPT->Language();

	$GLOBALS['premiumpress']['thumbresize'] 		= get_option("thumbresize");

	$post = get_post($_GET['d']); 
	
	$PASSCODE = '<h1>%title%</h1>
			 
			 <img src="%img%" width="80" height="70" alt="%title%" class="frame" />
			 
			 <p class="title">%price%</p>
			  
			 <p class="desc">%excerpt%..</p>         
			 
			 <div class="clearfix"></div>
			 
			 <div class="hh1"> 
			 
			<ul class="item_stats">
					 
					<li class="beds">%beds% Bedrooms</li>
					<li class="baths">%baths% Bathrooms</li>
				</ul>        
		  
			 <div class="clearfix"></div>
			 
			 </div>
			 
			<p><a href="%link%" class="btn">'.$PPT->_e(array('rp','_homepage6')).'</a></p>';
			 
			 $DisplayCode = str_replace("%title%",$post->post_title,str_replace("%img%",premiumpress_image($post->ID,"m",array('return'=>true)),str_replace("%price%",premiumpress_price(get_post_meta($post->ID, "price", true),get_option('currency_code'),"l",1),str_replace("%excerpt%",substr($post->post_excerpt,0,255),str_replace("%beds%",get_post_meta($post->ID, "bedrooms", true),str_replace("%baths%",get_post_meta($post->ID, "bathrooms", true),str_replace("%link%",get_permalink($post->ID),$PASSCODE)))))));
			 
	
	print  $DisplayCode;

}else{
 
print  '<a href="'.premiumpress_image_check(trim($_GET['d']),"full").'" class="cboxElement" onclick="jQuery.colorbox();"><img src="'.premiumpress_image_check(trim($_GET['d']),"full").'" class="subimg frame "></a>';

}


} break; 

}

?>